<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-07-23 Sat 17:24 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>Compiler</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Hebi Li" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<style>
a:visited {color: red;}
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Compiler</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline13">1. C Preprocessor (CPP)</a>
<ul>
<li><a href="#orgheadline3">1.1. The processing</a>
<ul>
<li><a href="#orgheadline1">1.1.1. Compiler option to separate them</a></li>
<li><a href="#orgheadline2">1.1.2. self-referential macro</a></li>
</ul>
</li>
<li><a href="#orgheadline9">1.2. Predefined macros</a>
<ul>
<li><a href="#orgheadline4">1.2.1. Standard (in language specification)</a></li>
<li><a href="#orgheadline5">1.2.2. Common GNU C extension</a></li>
<li><a href="#orgheadline8">1.2.3. system specific</a>
<ul>
<li><a href="#orgheadline6">1.2.3.1. MAC</a></li>
<li><a href="#orgheadline7">1.2.3.2. Ubuntu</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline10">1.3. Stringification</a></li>
<li><a href="#orgheadline11">1.4. token-pasting</a></li>
<li><a href="#orgheadline12">1.5. Line Markers</a></li>
</ul>
</li>
<li><a href="#orgheadline15">2. Special Notations</a>
<ul>
<li><a href="#orgheadline14">2.1. Line Control</a></li>
</ul>
</li>
<li><a href="#orgheadline16">3. GCC options</a></li>
<li><a href="#orgheadline17">4. Misc</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline13" class="outline-2">
<h2 id="orgheadline13"><span class="section-number-2">1</span> C Preprocessor (CPP)</h2>
<div class="outline-text-2" id="text-1">
<p>
The CPP Manual : <a href="https://gcc.gnu.org/onlinedocs/cpp/">https://gcc.gnu.org/onlinedocs/cpp/</a>
</p>
</div>
<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">1.1</span> The processing</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The following textural transformation is done before everything:
</p>

<ol class="org-ol">
<li>The input file is read into memory and broken into lines.</li>
<li>Continued lines (line ends with a backslash and newline) are merged into one long line.
There's NO way to prevent a backslash at the end of a line from being interpreted as a backslash-newline.</li>
<li>All comments are replaced with single spaces.
Block comments (<code>/* */</code>) does not nest.
Line comments (<code>//</code>) can nest because it doesn't matter.
It is safe to put line comments inside block comments, or vice versa.</li>
</ol>

<p>
After these steps, the tokenization is performed.
Then the true "preprocessing" is performed.
</p>

<p>
Preprocessing directives are lines in your program that start with <code>#</code>.
Whitespace is allowed before and after the <code>#</code>.
The ‘#’ is followed by an identifier, the directive name.
The ‘#’ which begins a directive cannot come from a macro expansion.
Also, the directive name is not macro expanded.
</p>

<p>
The primary directives do:
</p>
<ul class="org-ul">
<li>Inclusion of header files.</li>
<li>Macro expansion.</li>
<li>Conditional compilation.</li>
<li>Line control.</li>
<li>Diagnostics.</li>
</ul>

<p>
Macro has two kinds, <i>object like</i> (e.g. <code>BUFFER</code>) and <i>function like</i> (i.e. takes parameters).
For function-like macros,
all arguments to a macro are completely macro-expanded before they are substituted into the macro body.
</p>
</div>

<div id="outline-container-orgheadline1" class="outline-4">
<h4 id="orgheadline1"><span class="section-number-4">1.1.1</span> Compiler option to separate them</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Generally the compiler will do preprocessing, compilation, assembling, and linking in order.
</p>
<pre class="example">
cc -c a.c # do not do link ==&gt; a.o
cc -S a.c # do not do assembling =&gt; a.s
cc -E a.c # only do preprocessing, output to stdout &gt; a.i
</pre>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-4">
<h4 id="orgheadline2"><span class="section-number-4">1.1.2</span> self-referential macro</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
A self-referential macro is one whose name appears in its definition
</p>

<p>
The self-references that do not expand in the first scan are marked so that they will not expand in the second scan either.
e.g. <code>#define foo (4 + foo)</code>.
In most cases, it is a bad idea to take advantage of this feature.
</p>
</div>
</div>
</div>





<div id="outline-container-orgheadline9" class="outline-3">
<h3 id="orgheadline9"><span class="section-number-3">1.2</span> Predefined macros</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-orgheadline4" class="outline-4">
<h4 id="orgheadline4"><span class="section-number-4">1.2.1</span> Standard (in language specification)</h4>
<div class="outline-text-4" id="text-1-2-1">
<dl class="org-dl">
<dt><code>__FILE__</code></dt><dd>expands to the name of the current input file, in the form of a C string constant
This is the path by which the preprocessor opened the file, not the short name.</dd>
<dt><code>__LINE__</code></dt><dd>expands to the current input line number</dd>
</dl>

<p>
One typical use of these two macros are in log message.
</p>
<div class="org-src-container">

<pre class="src src-C">fprintf (stderr, <span style="color: #008000;">"Internal error: "</span>
         <span style="color: #008000;">"negative string length "</span>
         <span style="color: #008000;">"%d at %s, line %d."</span>,
         length, __FILE__, __LINE__);
</pre>
</div>

<p>
An ‘#include’ directive changes the expansions of <span class="underline"><span class="underline">FILE</span></span> and <span class="underline"><span class="underline">LINE</span></span> to correspond to the included file.
Revert back when coming back.
A ‘#line’ directive changes <span class="underline"><span class="underline">LINE</span></span>, and may change <span class="underline"><span class="underline">FILE</span></span> as well.
</p>

<p>
Note, for debugging purpose, it is nice to have the current function name.
However, the preprocessor does not know about what the function name is.
There does exist a <code>__func__</code> and <code>__FUNCTION__</code>, but they're not macros.
They are strings.
</p>

<dl class="org-dl">
<dt><code>__DATE__</code></dt><dd>expand to string constant, describing the date on which the preprocessor is being run.
The string constant contains eleven characters and looks like "Feb 12 1996".
If the day of the month is less than 10, it is padded with a space on the left.</dd>
<dt><code>__TIME__</code></dt><dd>The string constant contains eight characters and looks like "23:59:01".</dd>
<dt><code>__STDC__</code></dt><dd>most of the time equal to 1. I think just assume this.</dd>
<dt><code>__STDC_VERSION__</code></dt><dd>something like <code>199409L</code></dd>
<dt><code>__STDC_HOSTED__</code></dt><dd>should also be assumed to be 1</dd>
<dt><code>__cplusplus</code></dt><dd>defined when c++ compiler is used.</dd>
<dt><code>__OBJC__</code></dt><dd>defined when OBJ-C compiler is used.</dd>
<dt><code>__ASSEMBLER__</code></dt><dd>defined when running on assembly.</dd>
</dl>
</div>
</div>
<div id="outline-container-orgheadline5" class="outline-4">
<h4 id="orgheadline5"><span class="section-number-4">1.2.2</span> Common GNU C extension</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
I only list some interesting ones. For the full list see the page in <a href="https://gcc.gnu.org/onlinedocs/cpp/Common-Predefined-Macros.html">gcc manual</a>.
</p>
<dl class="org-dl">
<dt><code>__COUNTER__</code></dt><dd>expands to sequential integral values starting from 0.</dd>
<dt><code>__GNUC__</code></dt><dd>int, major version</dd>
<dt><code>__GNUC_MINOR__</code></dt><dd>int, minor version</dd>
</dl>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-4">
<h4 id="orgheadline8"><span class="section-number-4">1.2.3</span> system specific</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
To find the macros that are defined in current system:
</p>

<div class="org-src-container">

<pre class="src src-shell">cpp -dM - <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">use standard input</span>
C-d <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">EOF, see result</span>
</pre>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-5">
<h5 id="orgheadline6"><span class="section-number-5">1.2.3.1</span> MAC</h5>
<div class="outline-text-5" id="text-1-2-3-1">
<pre class="example">
#define OBJC_NEW_PROPERTIES 1
#define _LP64 1
#define __APPLE_CC__ 6000
#define __APPLE__ 1
#define __LP64__ 1
#define __MACH__ 1
#define __MMX__ 1
#define __clang__ 1
#define __clang_major__ 7
#define __clang_minor__ 3
#define __llvm__ 1
#define __x86_64 1
#define __x86_64__ 1
</pre>
</div>
</div>

<div id="outline-container-orgheadline7" class="outline-5">
<h5 id="orgheadline7"><span class="section-number-5">1.2.3.2</span> Ubuntu</h5>
<div class="outline-text-5" id="text-1-2-3-2">
<pre class="example">
#define __unix__ 1
#define __linux 1
#define __unix 1
#define __linux__ 1
#define unix 1
#define __x86_64__ 1
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline10" class="outline-3">
<h3 id="orgheadline10"><span class="section-number-3">1.3</span> Stringification</h3>
<div class="outline-text-3" id="text-1-3">
<p>
<a href="https://gcc.gnu.org/onlinedocs/cpp/Stringification.html">https://gcc.gnu.org/onlinedocs/cpp/Stringification.html</a>
</p>

<p>
Parameters are not replaced inside string constants.
</p>

<p>
When a macro parameter is used with a leading ‘#’,
the preprocessor replaces it with the literal text of the actual argument, converted to a string constant.
Unlike normal parameter replacement, the argument is not macro-expanded first.
This is called stringification.
</p>

<p>
Stringification in C involves more than putting double-quote characters around the fragment.
The preprocessor backslash-escapes the quotes surrounding embedded string constants,
and all backslashes within string and character constants,
in order to get a valid C string constant with the proper contents. 
</p>
</div>
</div>
<div id="outline-container-orgheadline11" class="outline-3">
<h3 id="orgheadline11"><span class="section-number-3">1.4</span> token-pasting</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<a href="https://gcc.gnu.org/onlinedocs/cpp/Concatenation.html">https://gcc.gnu.org/onlinedocs/cpp/Concatenation.html</a>
</p>

<p>
<code>token pasting</code> or <code>token concatenation</code>
</p>

<p>
When a macro is expanded,
the two tokens on either side of each <code>##</code> operator are combined into a single token,
which then replaces the <code>##</code> and the two original tokens in the macro expansion. 
</p>

<p>
Two tokens that don't together form a valid token cannot be pasted together.
CPP will give warning.
</p>


<div class="org-src-container">

<pre class="src src-C"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">command</span>
{
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span>;
  <span style="color: #6434A3;">void</span> (*<span style="color: #006699;">function</span>) (<span style="color: #6434A3;">void</span>);
};
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">command</span> <span style="color: #BA36A5;">commands</span>[] =
  {
    { <span style="color: #008000;">"quit"</span>, quit_command },
    { <span style="color: #008000;">"help"</span>, help_command },
    ...
  };
</pre>
</div>

<p>
can be wrote as:
</p>
<div class="org-src-container">

<pre class="src src-C"><span style="color: #808080;">#define</span> <span style="color: #006699;">COMMAND</span>(<span style="color: #BA36A5;">NAME</span>)  { #NAME, NAME ## _command }
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">command</span> <span style="color: #BA36A5;">commands</span>[] =
  {
    COMMAND (quit),
    COMMAND (help),
    ...
  };
</pre>
</div>

<p>
Another example:
</p>
<div class="org-src-container">

<pre class="src src-C"><span style="color: #808080;">#define</span> <span style="color: #006699;">paster</span>( <span style="color: #BA36A5;">n</span> ) printf_s( <span style="color: #008000;">"token"</span> #n <span style="color: #008000;">" = %d"</span>, token##n )
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">token9</span> = 9;
</pre>
</div>

<p>
becomes
</p>
<div class="org-src-container">

<pre class="src src-C">printf_s( <span style="color: #008000;">"token"</span> <span style="color: #008000;">"9"</span> <span style="color: #008000;">" = %d"</span>, token9 );
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">=&gt;</span>
printf_s( <span style="color: #008000;">"token9 = %d"</span>, token9 );
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline12" class="outline-3">
<h3 id="orgheadline12"><span class="section-number-3">1.5</span> Line Markers</h3>
<div class="outline-text-3" id="text-1-5">
<pre class="example">
# linenum filename flags
</pre>

<p>
They mean that the following line originated in file filename at line linenum.
</p>

<p>
After the file name comes zero or more flags, which are ‘1’, ‘2’, ‘3’, or ‘4’.
If there are multiple flags, spaces separate them, and must be in ascending order.
</p>

<dl class="org-dl">
<dt><code>1</code></dt><dd>This indicates the start of a new file.</dd>
<dt><code>2</code></dt><dd>This indicates returning to a file (after having included another file).</dd>
<dt><code>3</code></dt><dd>This indicates that the following text comes from a system header file, so certain warnings should be suppressed.</dd>
<dt><code>4</code></dt><dd>This indicates that the following text should be treated as being wrapped in an implicit extern "C" block.</dd>
</dl>

<p>
They are treated like the corresponding <code>#line</code> directive,
except that trailing flags are permitted.
</p>
</div>
</div>
</div>


<div id="outline-container-orgheadline15" class="outline-2">
<h2 id="orgheadline15"><span class="section-number-2">2</span> Special Notations</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgheadline14" class="outline-3">
<h3 id="orgheadline14"><span class="section-number-3">2.1</span> Line Control</h3>
<div class="outline-text-3" id="text-2-1">
<p>
It can have three formats:
</p>
<dl class="org-dl">
<dt><code>#line linum</code></dt><dd>a non-negative integer</dd>
<dt><code>#line linum filename</code></dt><dd>a string constant</dd>
<dt><code>#line anything else</code></dt><dd>This is just a dummy, anything else must be a macro, and expands to the above two format.</dd>
</dl>

<p>
The only things that changed are <code>__FILE__</code> and <code>__LINE__</code>.
</p>
</div>
</div>
</div>


<div id="outline-container-orgheadline16" class="outline-2">
<h2 id="orgheadline16"><span class="section-number-2">3</span> GCC options</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><code>-include</code> include file before parsing</li>
<li><code>-include-pch</code> include precompiled header file (often names as <code>header.h.gch</code>)
Note that generally the include directive will look for the <code>.h.gch</code> version
right before looking for <code>.h</code> file in each directory.</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline17" class="outline-2">
<h2 id="orgheadline17"><span class="section-number-2">4</span> Misc</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li><code>nm a.o</code> list symbols from object files</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Hebi Li</p>
<p class="date">Created: 2016-07-23 Sat 17:24</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
